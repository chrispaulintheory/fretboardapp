<!DOCTYPE html>
<html lang="en">
<!-- version 2025-10-27-2315 -->
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Intervals</title>
<style>
  body {
    margin: 0;
    background: #fff;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center;
  }
  h2 { margin: 16px 12px 6px; }

  #levelButtons {
    display: flex; gap: 10px; margin: 8px 0 6px;
  }
  .level-btn {
    background: #ccc; color: #333; border: 0; border-radius: 6px;
    padding: 8px 14px; font-size: 16px; cursor: pointer;
    transition: all 0.2s ease;
  }
  .level-btn:hover { background: #bbb; }
  .level-btn.active {
    background: #7e3ff2; color: #fff;
    transform: scale(1.05);
  }
  #levelDescription {
    font-size: 15px;
    color: #555;
    margin-bottom: 12px;
    text-align: center;
    max-width: 90%;
  }

  #bestScoreDisplay {
    font-weight: 600;
    color: #444;
    margin-top: 6px;
  }

  #controls {
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    justify-content: center; margin: 6px 0 10px;
  }
  button {
    background: #7e3ff2; color: #fff; border: 0; border-radius: 8px;
    padding: 10px 18px; font-size: 16px; cursor: pointer;
  }
  button:hover { filter: brightness(.95); }
  #resetBtn { display: none; background: #888; }
  #timer { font-weight: 700; }
  #feedback { min-height: 28px; font-weight: 700; }
  #scoreboard { font-weight: 600; }

  #board {
    position: relative; width: 1400px; height: 200px;
    background: url("{{ url_for('static', filename='cg-longneck.png') }}") center/contain no-repeat;
    border: 1px solid #ccc; margin: 8px 12px 12px;
  }
  .dot {
    position: absolute; width: 26px; height: 26px; border-radius: 50%;
    background: #7e3ff2; border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
    transform: translate(-50%, -50%);
  }

  /* ---- Game control buttons ---- */
  .game-controls-wrapper {
    text-align: center;
    margin-bottom: 20px;
  }
  .game-controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }
  .game-controls button {
    background: #fff;
    color: #333;
    border: 2px solid #888;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .game-controls button:hover { background: #eee; }
  .game-controls button.active-press {
    background: #7e3ff2;
    color: #fff;
    border-color: #7e3ff2;
    transform: scale(0.96);
  }
</style>
</head>
<body>
<h2>Intervals</h2>

<div id="levelButtons">
  <button class="level-btn active" data-level="1">Level 1</button>
  <button class="level-btn" data-level="2">Level 2</button>
  <button class="level-btn" data-level="3" disabled>Level 3</button>
</div>

<div id="levelDescription">
  Level 1: Perfect intervals (P1, P4, P5, P8) and the Tritone (A4/D5) on E–A–D–G string set.
</div>

<div id="bestScoreDisplay">
  Best Score: {{ best_score or 0 }}
</div>

<div id="controls">
  <button id="startBtn">Start</button>
  <button id="resetBtn">Reset</button>
  <div id="timer">2:00</div>
  <div id="scoreboard">Score: <span id="score">0</span></div>
  <div id="feedback"></div>
</div>

<div id="board"></div>

<!-- Controls legend -->
<div class="game-controls-wrapper text-center">
  <div class="game-controls" id="controlButtons">
    <button data-key="1">UNISON (1)</button>
    <button data-key="4">PERFECT 4th (4)</button>
    <button data-key="5">PERFECT 5th (5)</button>
    <button data-key="t">TRITONE (T)</button>
    <button data-key="8">OCTAVE (8)</button>
  </div>
</div>

<script>
/* ---------- Setup ---------- */
const board=document.getElementById('board');
const startBtn=document.getElementById('startBtn');
const resetBtn=document.getElementById('resetBtn');
const timerEl=document.getElementById('timer');
const scoreEl=document.getElementById('score');
const feedback=document.getElementById('feedback');
const levelButtons=document.querySelectorAll('.level-btn');
const controlButtons=document.querySelectorAll('#controlButtons button');
const bestScoreDisplay=document.getElementById('bestScoreDisplay');

const TOTAL_FRETS=22,GAME_SECONDS=120;
const stringY={6:75,5:62,4:49,3:36,2:23,1:10};
const notes=['C','C♯','D','D♯','E','F','F♯','G','G♯','A','A♯','B'];
const openNotes={6:'E',5:'A',4:'D',3:'G',2:'B',1:'E'};
const openMidi={6:40,5:45,4:50,3:55,2:59,1:64};
const noteAt=(s,f)=>notes[(notes.indexOf(openNotes[s])+f)%12];
const midiAt=(s,f)=>openMidi[s]+f;
const fretX=f=>((f+0.5)/(TOTAL_FRETS+1))*100;
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=a=>a[Math.floor(Math.random()*a.length)];
const clearDots=()=>document.querySelectorAll('.dot').forEach(d=>d.remove());
const normalizeAccidentals=n=>(n==='E♯'?'F':n==='B♯'?'C':n);

let score=0,timeLeft=GAME_SECONDS,timer=null,gameActive=false,currentInterval=null;
let s1=0,f1=0,s2=0,f2=0,n1='',n2='',level=1,lastInterval=null;

/* ---------- Interval Generators ---------- */
function genP1(strSet){const pairs=[];for(let i=0;i<strSet.length-1;i++)pairs.push([strSet[i+1],strSet[i]]);const[upper,lower]=pick(pairs);const f=randInt(0,TOTAL_FRETS-5);return[upper,f,lower,f+5];}
function genP4(strSet){const pairs=[];for(let i=0;i<strSet.length-1;i++)pairs.push([strSet[i+1],strSet[i]]);const[upper,lower]=pick(pairs);const f=randInt(0,TOTAL_FRETS);return[upper,f,lower,f];}
function genP5(strSet){if(Math.random()<0.5){const pairs=[];for(let i=0;i<strSet.length-1;i++)pairs.push([strSet[i],strSet[i+1]]);const[lowS,upS]=pick(pairs);const fLow=randInt(0,TOTAL_FRETS-2);return[lowS,fLow,upS,fLow+2];}else{const pairs=[];for(let i=0;i<strSet.length-2;i++)pairs.push([strSet[i],strSet[i+2]]);const[lowS,upS]=pick(pairs);const fLow=randInt(3,TOTAL_FRETS);return[lowS,fLow,upS,fLow-3];}}
function genP8(strSet){const pairs=[];for(let i=0;i<strSet.length-2;i++)pairs.push([strSet[i],strSet[i+2]]);const[lowS,upS]=pick(pairs);const fLow=randInt(0,TOTAL_FRETS-2);return[lowS,fLow,upS,fLow+2];}
function genTT(strSet){const validPairs=[[6,5,1],[5,4,1],[4,3,1],[3,2,0],[2,1,1]];const[lowS,upS,offset]=pick(validPairs.filter(p=>strSet.includes(p[0])&&strSet.includes(p[1])));const fLow=randInt(0,TOTAL_FRETS-offset-1);return[lowS,fLow,upS,fLow+offset];}

/* ---------- Draw Interval ---------- */
function drawInterval(){
  clearDots();
  const strSet=level===1?[6,5,4,3]:[6,5,4,3,2,1];
  const intervals=['p1','p4','p5','tt','p8'];
  let nextInterval;
  do { nextInterval = pick(intervals); } while(nextInterval === lastInterval);
  lastInterval = nextInterval;
  currentInterval = nextInterval;

  if(currentInterval==='p1')[s1,f1,s2,f2]=genP1(strSet);
  else if(currentInterval==='p4')[s1,f1,s2,f2]=genP4(strSet);
  else if(currentInterval==='p5')[s1,f1,s2,f2]=genP5(strSet);
  else if(currentInterval==='tt')[s1,f1,s2,f2]=genTT(strSet);
  else [s1,f1,s2,f2]=genP8(strSet);

  n1=normalizeAccidentals(noteAt(s1,f1));
  n2=normalizeAccidentals(noteAt(s2,f2));

  const d1=document.createElement('div');d1.className='dot';d1.style.left=fretX(f1)+'%';d1.style.top=stringY[s1]+'%';
  const d2=document.createElement('div');d2.className='dot';d2.style.left=fretX(f2)+'%';d2.style.top=stringY[s2]+'%';
  board.append(d1,d2);
}

/* ---------- Feedback ---------- */
function feedbackTextForCurrent(){
  const a={s:s1,f:f1,name:n1,midi:midiAt(s1,f1)};
  const b={s:s2,f:f2,name:n2,midi:midiAt(s2,f2)};
  const low=a.midi<=b.midi?a:b;const high=a.midi<=b.midi?b:a;
  const semis=Math.abs(a.midi-b.midi);
  const names={p1:'Perfect Unison',p4:'Perfect 4th',p5:'Perfect 5th',tt:'Tritone',p8:'Perfect Octave'};
  if(currentInterval==='tt'){
    const letters=['C','D','E','F','G','A','B'];
    const lowI=letters.indexOf(low.name[0]);
    const highI=letters.indexOf(high.name[0]);
    const letterDistance=(highI-lowI+7)%7+1;
    const quality=(letterDistance===4?'Augmented 4th':'Diminished 5th');
    return `${low.name}–${high.name} is a ${quality}, a Tritone!`;
  }
  return currentInterval==='p8'
    ? `${low.name}–${high.name}ʹ is a ${names[currentInterval]}!`
    : `${low.name}–${high.name} is a ${names[currentInterval]}!`;
}

/* ---------- Game Flow ---------- */
function updateTimer(){const m=Math.floor(timeLeft/60),s=String(timeLeft%60).padStart(2,'0');timerEl.textContent=`${m}:${s}`;}
function startGame(){
  if(gameActive)return;
  score=0;scoreEl.textContent=score;timeLeft=GAME_SECONDS;updateTimer();
  feedback.textContent='';gameActive=true;
  startBtn.style.display='none';resetBtn.style.display='none';
  drawInterval();
  timer=setInterval(()=>{timeLeft--;updateTimer();if(timeLeft<=0)endGame();},1000);
}
function endGame(){
  clearInterval(timer);timer=null;gameActive=false;
  feedback.textContent='⏰ Time’s up!';clearDots();resetBtn.style.display='inline-block';
  fetch('/submit_score',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({score})
  }).then(r=>r.json()).then(data=>{
    if(data.saved){bestScoreDisplay.textContent=`Best Score: ${data.score}`;}
  }).catch(e=>console.error('Score save error:',e));
}
function resetGame(){clearInterval(timer);timer=null;score=0;scoreEl.textContent=score;
  timeLeft=GAME_SECONDS;updateTimer();feedback.textContent='';clearDots();
  resetBtn.style.display='none';startBtn.style.display='inline-block';}

/* ---------- Input Handling ---------- */
function handleAnswer(key){
  if(!gameActive)return;
  const expected=currentInterval==='p1'?'1':currentInterval==='p4'?'4':currentInterval==='p5'?'5':currentInterval==='tt'?'t':'8';
  if(key===expected){
    score+=10;scoreEl.textContent=score;
    feedback.textContent=`✅ Correct! ${feedbackTextForCurrent()}`;
    feedback.style.color='green';
    setTimeout(()=>{feedback.textContent='';drawInterval();},900);
  }else if(['1','4','5','8','t'].includes(key)){
    score-=5;scoreEl.textContent=score;
    feedback.textContent='❌ Wrong';feedback.style.color='red';
  }
}

document.addEventListener('keydown',e=>{
  const key=e.key.toLowerCase();
  handleAnswer(key);
  controlButtons.forEach(btn=>{
    if(btn.dataset.key===key){btn.classList.add('active-press');setTimeout(()=>btn.classList.remove('active-press'),150);}
  });
});
controlButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const key=btn.dataset.key;
    btn.classList.add('active-press');
    setTimeout(()=>btn.classList.remove('active-press'),150);
    handleAnswer(key);
  });
});
startBtn.addEventListener('click',startGame);
resetBtn.addEventListener('click',resetGame);
</script>
</body>
</html>